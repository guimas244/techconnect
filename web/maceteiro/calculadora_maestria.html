<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Techterra - Calculadora de Maestria</title>
<style>
  :root{
    --bg1:#f8fafc; --bg2:#eef2f7; --card:#ffffff; --border:#dbe1ea; --ink:#0f172a;
    --muted:#64748b; --brand:#0ea5e9; --ok:#10b981; --warn:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1600px;margin:0 auto;padding:8px}
  h1{margin:0 0 8px;font-size:28px;letter-spacing:-.02em}
  button{cursor:pointer}
  .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 12px;font-weight:600}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .grid{display:grid;gap:8px}
  .grid.main{grid-template-columns:1fr; }
  @media(min-width:1024px){ .grid.main{grid-template-columns:380px 1fr;} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 2px 8px rgba(2,8,23,.04)}
  .card .pad{padding:12px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .muted{color:var(--muted);font-size:12px}
  .input, select{width:100%;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font:inherit}
  .progress{height:8px;background:#e6edf6;border-radius:999px;overflow:hidden}
  .progress .bar{height:100%;background:linear-gradient(90deg,#22c55e,#16a34a);width:0}
  .badge{border:1px solid var(--border);border-radius:999px;font-size:12px;padding:6px 10px}
  .badge.ok{border-color:#86efac;background:#ecfdf5}
  .badge.warn{border-color:#fecaca;background:#fef2f2}
  .uploader{width:112px;height:112px;border:1px dashed var(--border);border-radius:14px;display:flex;align-items:center;justify-content:center;overflow:hidden;background:#f1f5f9}
  .uploader img{width:100%;height:100%;object-fit:cover}
  .life-grid{display:grid;grid-template-columns:2fr 1fr;gap:8px}
  .life-grid .lbl{align-self:center;font-size:14px}
  .life-grid .input-wrapper{position:relative}
  .life-grid .input-wrapper input{padding-right:24px}
  .life-grid .input-wrapper::after{content:'%';position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--muted);pointer-events:none;font-size:12px}
  .types-grid{display:grid;grid-template-columns:1fr;gap:8px;min-width:0}
  @media(min-width:768px){ .types-grid{grid-template-columns:1fr 1fr 1fr;} }
  .type-card{display:flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:12px;padding:8px;background:#fff;min-width:0}
  .type-ico{width:48px;height:48px;border-radius:12px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;background:#f8fafc;flex:0 0 auto;overflow:hidden}
  .type-ico img{width:100%;height:100%;object-fit:contain;padding:4px}
  .type-row{display:grid;gap:8px;align-items:center;grid-template-columns:1fr 1fr;min-width:0}
  .type-row > *{min-width:0}
  dialog{border:none;border-radius:16px;max-width:800px;width:calc(100% - 24px);padding:0;box-shadow:0 10px 40px rgba(2,8,23,.25)}
  dialog::backdrop{background:rgba(15,23,42,.45)}
  .tbl{width:100%;border-collapse:collapse}
  .tbl th,.tbl td{border-bottom:1px solid var(--border);padding:10px 8px;font-size:14px;text-align:left}
  .tbl th{font-size:12px;text-transform:uppercase;letter-spacing:.06em;color:var(--muted)}
  .footer-tip{margin-top:8px;font-size:12px;color:var(--muted)}
  .totals{display:flex;align-items:center;gap:8px}
  .pill{padding:6px 10px;border-radius:999px;background:#f1f5f9;border:1px solid var(--border);font-size:12px}
  select{max-width:100%}
  .result-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;max-height:500px;overflow-y:auto}
  .result-item{display:flex;align-items:center;gap:8px;padding:8px;border:1px solid var(--border);border-radius:8px;background:#fff}
  .result-item .type-ico{width:32px;height:32px;border-radius:8px}
  .result-info{flex:1;min-width:0}
  .result-info .type-name{font-weight:600;font-size:13px}
  .result-info .mastery-level{font-size:11px;color:var(--muted)}
  .result-info .mastery-points{font-size:12px;color:var(--brand);font-weight:600}

  /* Modo de visualiza√ß√£o para print */
  .view-mode{display:none}
  .view-mode.active{display:block}
  .edit-mode.hidden{display:none}
  .print-layout{max-width:1800px;margin:0 auto;padding:32px;min-width:1400px}
  .print-header{margin-bottom:16px;padding-bottom:10px;border-bottom:2px solid var(--border)}
  .print-header h1{font-size:26px;margin:0 0 4px 0}
  .print-header .subtitle{color:var(--muted);font-size:12px}

  /* Perfil compacto no topo */
  .print-profile-compact{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:20px;display:flex;align-items:center;gap:16px}
  .print-photo-small{width:80px;height:80px;border-radius:12px;border:2px solid var(--border);overflow:hidden;background:#f1f5f9;display:flex;align-items:center;justify-content:center;flex-shrink:0}
  .print-photo-small img{width:100%;height:100%;object-fit:cover}
  .print-profile-info{flex:1;display:flex;gap:24px;flex-wrap:wrap;align-items:center}
  .print-info-item{display:flex;flex-direction:column;gap:2px}
  .print-info-item .label{color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:0.05em}
  .print-info-item .value{font-weight:700;font-size:15px}

  /* Se√ß√£o de maestrias - foco principal */
  .print-section{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px}
  .print-section h2{margin:0 0 20px 0;font-size:22px;font-weight:700;border-bottom:2px solid var(--border);padding-bottom:14px}

  /* Grid de tipos - 6 colunas para formato paisagem, layout HORIZONTAL compacto */
  .print-types-grid{display:grid;grid-template-columns:repeat(6, 1fr);gap:12px}
  .print-type-item{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg1);border-radius:10px;border:1px solid var(--border)}
  .print-type-item .type-ico{width:42px;height:42px;border-radius:8px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;background:#fff;overflow:hidden;flex-shrink:0}
  .print-type-item .type-ico img{width:100%;height:100%;object-fit:contain;padding:3px}
  .print-type-item .type-info{flex:1;min-width:0;display:flex;flex-direction:column;gap:2px}
  .print-type-item .type-level{font-size:12px;color:var(--ink);font-weight:600;line-height:1.2}
  .print-type-item .type-points{font-size:10px;color:var(--muted);font-weight:500}

  .print-actions{position:fixed;top:16px;right:16px;display:flex;gap:8px;z-index:1000;background:rgba(255,255,255,0.95);padding:8px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}

  /* Responsivo para telas menores */
  @media(max-width:1600px){
    .print-types-grid{grid-template-columns:repeat(5, 1fr)}
  }
  @media(max-width:1300px){
    .print-types-grid{grid-template-columns:repeat(4, 1fr)}
  }
  @media(max-width:1000px){
    .print-types-grid{grid-template-columns:repeat(3, 1fr)}
  }
</style>
</head>
<body>
  <!-- Modo de Edi√ß√£o -->
  <div class="wrap edit-mode" id="editMode">
    <div class="row" style="margin-bottom:14px">
      <h1>Techterra - Calculadora de Maestria</h1>
      <div class="row" style="gap:8px">
        <button id="btnConfig" class="btn" type="button">‚öôÔ∏è Configurar</button>
      </div>
    </div>

    <div id="exportArea" class="grid main">
      <!-- Painel do treinador -->
      <div class="card">
        <div class="pad grid" style="gap:8px">
          <div class="row"><strong>Perfil do treinador</strong></div>

          <div class="row" style="align-items:flex-start;gap:8px">
            <label class="uploader" title="Anexar imagem">
              <input id="imgInput" type="file" accept="image/*" style="display:none">
              <img id="imgPreview" alt="Anexar imagem">
            </label>
            <div style="flex:1">
              <label class="muted">Nome</label>
              <input id="nome" class="input" placeholder="Nome do treinador">
            </div>
          </div>

          <div class="grid" style="grid-template-columns:1fr 1fr 1fr;gap:8px">
            <div>
              <label class="muted">Anos de treinador</label>
              <input id="anos" type="number" min="0" class="input">
              <div id="diasHint" class="muted" style="margin-top:4px"></div>
            </div>
            <div>
              <label class="muted">Dedica√ß√£o geral</label>
              <input id="dedGeral" type="number" min="0" max="100" class="input">
            </div>
            <div>
              <label class="muted">Potencial geral</label>
              <input id="potGeral" type="number" min="0" max="100" class="input">
            </div>
          </div>

          <div>
            <div class="row" style="margin-bottom:8px">
              <div class="pill">Dedica√ß√£o por aspecto de vida</div>
              <div id="lifeBadge" class="badge">Total 0%</div>
            </div>
            <div class="progress" style="margin-bottom:8px"><div id="lifeBar" class="bar"></div></div>
            <div class="life-grid" id="lifeGrid"></div>
            <div id="lifeWarn" class="muted" style="color:var(--warn);display:none">A soma deve ser 100%</div>

            <div class="card" style="margin-top:10px">
              <div class="pad row">
                <div><strong>√çndice ponderado de dedica√ß√£o</strong></div>
                <div id="weighted" class="pill">0.00</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Maestria por tipo -->
      <div class="card">
        <div class="pad grid" style="gap:8px">
          <div class="row">
            <strong>Maestria por tipo</strong>
            <div class="totals">
              <span id="typeBadge" class="badge">Total 0%</span>
            </div>
          </div>
          <div class="progress" style="margin-bottom:8px"><div id="typeBar" class="bar"></div></div>
          <div id="typesGrid" class="types-grid"></div>

          <div class="row" style="justify-content:flex-end">
            <button id="btnGerar" class="btn primary" disabled>üéØ Calcular Maestrias</button>
          </div>
        </div>
      </div>
    </div>

    <div class="footer-tip">Dica: valores ficam salvos automaticamente no cache do navegador.</div>
  </div>

  <!-- Modo de Visualiza√ß√£o (Print) -->
  <div class="view-mode" id="viewMode">
    <div class="print-actions">
      <button id="btnDownloadJPG" class="btn primary">‚¨áÔ∏è Baixar JPG</button>
      <button id="btnBackEdit" class="btn">‚úèÔ∏è Voltar para edi√ß√£o</button>
    </div>

    <div class="print-layout">
      <div class="print-header">
        <h1>Techterra - Registro de Maestria</h1>
        <div class="subtitle">Calculado em: <span id="printDate"></span> | √çndice ponderado: <span id="printIndice"></span></div>
      </div>

      <!-- Perfil compacto -->
      <div class="print-profile-compact">
        <div class="print-photo-small" id="printPhoto">
          <span style="color:#94a3b8;font-size:11px">Sem imagem</span>
        </div>
        <div class="print-profile-info" id="printProfileInfo"></div>
      </div>

      <!-- Maestrias por tipo - FOCO PRINCIPAL -->
      <div class="print-section">
        <h2>Maestrias por Tipo</h2>
        <div class="print-types-grid" id="printTypesGrid"></div>
      </div>
    </div>
  </div>

  <!-- Modal de Configura√ß√£o (pesos fixos, s√≥ leitura) -->
  <dialog id="dlg">
    <div class="pad grid" style="gap:14px">
      <div class="row">
        <strong>Tabela de maestrias e pesos</strong>
        <button class="btn" onclick="dlg.close()">OK</button>
      </div>

      <div class="card"><div class="pad">
        <div class="muted" style="margin-bottom:6px">Edite os valores alvo de cada n√≠vel de maestria. Os pesos abaixo s√£o fixos.</div>
        <table class="tbl" id="tblMasteries">
          <thead><tr><th>Nome</th><th style="width:140px">Valor</th></tr></thead>
          <tbody></tbody>
        </table>
      </div></div>

      <div class="card"><div class="pad">
        <div class="row"><span class="muted">Pesos de dedica√ß√£o por aspecto de vida (fixos)</span></div>
        <table class="tbl" id="tblPesos">
          <thead><tr><th>Aspecto</th><th style="width:140px">Peso</th></tr></thead>
          <tbody></tbody>
        </table>
      </div></div>
    </div>
  </dialog>

  <!-- html2canvas para captura de screenshot -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
// ---------- Dados e estado ----------
const LS = {
  masteryLevels: "techterra_mastery_levels_v1",
  trainerPanel: "techterra_trainer_panel_v1",
  lifeDedication: "techterra_life_dedication_v1",
  typeDedication: "techterra_type_dedication_v1",
  uploadedImage: "techterra_uploaded_image_v1",
};

const defaultMasteries = [
  { name: "Sem Maestria", value: 0 },
  { name: "Inexperiente", value: 5 },
  { name: "Iniciante", value: 20 },
  { name: "Treinador", value: 100 },
  { name: "Especialista", value: 300 },
  { name: "Mestre", value: 800 },
  { name: "Campe√£o", value: 1200 },
  { name: "Raiz", value: 2000 },
  { name: "Pilar", value: 2500 },
  { name: "Lenda", value: 3500 },
  { name: "Deus", value: 5000 },
];

const lifeFields = [
  "Vida pessoal",
  "Batalha de cidade",
  "Batalha de floresta",
  "Campeonatos",
  "Treinamento",
  "Estudo geral de monstros",
  "Cria√ß√£o",
  "Domar",
  "Artes√£o",
  "Estudo de taticas",
];

// Pesos FIXOS (n√£o edit√°veis)
const fixedWeights = {
  "Vida pessoal": 0,
  "Batalha de cidade": 1.2,
  "Batalha de floresta": 1.4,
  "Campeonatos": 1.5,
  "Treinamento": 1.3,
  "Estudo geral de monstros": 1.1,
  "Cria√ß√£o": 1,
  "Domar": 1.3,
  "Artes√£o": 1,
  "Estudo de taticas": 1.4,
};

const typeList = [
  "Normal","Planta","Inseto","Venenoso","Fera","Zumbi","Marinho","Voador","Subterr√¢neo","Terrestre","Fogo","Gelo","√Ågua","Vento","El√©trico","Pedra","Luz","Trevas","Nost√°lgico","M√≠stico","Drag√£o","Alien","D√≥crates","Fantasma","Ps√≠quico","M√°gico","Tecnologia","Tempo","Desconhecido","Deus"
];

// Mapa de tipos para nomes de arquivo
const typeSlugMap = {
  "Normal":"normal","Planta":"planta","Inseto":"inseto","Venenoso":"venenoso","Fera":"fera","Zumbi":"zumbi",
  "Marinho":"marinho","Voador":"voador","Subterr√¢neo":"subterraneo","Terrestre":"terrestre","Fogo":"fogo",
  "Gelo":"gelo","√Ågua":"agua","Vento":"vento","El√©trico":"eletrico","Pedra":"pedra","Luz":"luz","Trevas":"trevas",
  "Nost√°lgico":"nostalgico","M√≠stico":"mistico","Drag√£o":"dragao","Alien":"alien","D√≥crates":"docrates",
  "Fantasma":"fantasma","Ps√≠quico":"psiquico","M√°gico":"magico","Tecnologia":"tecnologia","Tempo":"tempo",
  "Desconhecido":"desconhecido","Deus":"deus"
};

// Placeholder SVG para imagem padr√£o
const PLACEHOLDER = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
  <svg xmlns="http://www.w3.org/2000/svg" width="112" height="112" viewBox="0 0 112 112">
    <defs>
      <linearGradient id="g" x1="0" x2="0" y1="0" y2="1">
        <stop offset="0" stop-color="#f8fafc"/><stop offset="1" stop-color="#e2e8f0"/>
      </linearGradient>
    </defs>
    <rect x="1" y="1" width="110" height="110" rx="14" fill="url(#g)" stroke="#dbe1ea"/>
    <g fill="#94a3b8">
      <circle cx="56" cy="44" r="10"/>
      <path d="M22 88c7-15 18-24 34-24s27 9 34 24" fill="none" stroke="#94a3b8" stroke-width="4" stroke-linecap="round"/>
      <path d="M56 34v20M46 44h20" stroke="#94a3b8" stroke-width="4" stroke-linecap="round"/>
    </g>
  </svg>
`);

let masteries = load(LS.masteryLevels, defaultMasteries);
let trainer = load(LS.trainerPanel, { nome:"", anos:0, dedicacaoGeral:0, potencialGeral:0 });
let life = load(LS.lifeDedication, Object.fromEntries(lifeFields.map(k=>[k,0])));
let types = load(LS.typeDedication, typeList.map(t=>({type:t,pct:0,potencial:50})) );
let photo = localStorage.getItem(LS.uploadedImage) || "";

// ---------- Helpers ----------
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function load(key, fallback){
  const v = localStorage.getItem(key);
  if(!v) return fallback;
  try{ return JSON.parse(v); }catch{ return fallback; }
}
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function sum(arr){ return arr.reduce((a,b)=>a+Number(b||0),0); }

// Fun√ß√£o para obter o caminho da imagem do tipo
function getTypeImagePath(typeName){
  const slug = typeSlugMap[typeName];
  if(!slug) return null;
  return `./tipagens/icon_tipo_${slug}.png`;
}

function refreshTrainerUI(){
  nome.value = trainer.nome;
  anos.value = trainer.anos;
  dedGeral.value = trainer.dedicacaoGeral;
  potGeral.value = trainer.potencialGeral;
  diasHint.textContent = `Equivale a ${Math.max(0, Number(trainer.anos||0))*365} dias`;
  imgPreview.src = photo ? photo : PLACEHOLDER;
  imgPreview.alt = photo ? "Imagem do personagem" : "Anexar imagem";
}

function refreshLifeUI(){
  lifeGrid.innerHTML = "";
  lifeFields.forEach(k=>{
    const rowLbl = document.createElement('div');
    rowLbl.className = "lbl";
    rowLbl.textContent = k;
    const rowInp = document.createElement('div');
    rowInp.className = "input-wrapper";
    const inp = document.createElement('input');
    inp.type = "number"; inp.className = "input"; inp.value = life[k]; inp.min=0; inp.max=100;
    inp.addEventListener('input', e=>{
      life[k] = clamp(Number(e.target.value||0), 0, 100);
      save(LS.lifeDedication, life);
      refreshLifeTotals();
      refreshWeighted();
    });
    rowInp.appendChild(inp);
    lifeGrid.appendChild(rowLbl);
    lifeGrid.appendChild(rowInp);
  });
  refreshLifeTotals();
  refreshWeighted();
}

function refreshLifeTotals(){
  const total = sum(Object.values(life));
  lifeBar.style.width = Math.min(100,total) + "%";
  lifeBadge.textContent = `Total ${total}%`;
  lifeBadge.className = "badge " + (total===100 ? "ok":"warn");
  lifeWarn.style.display = total===100 ? "none":"block";
  btnGerar.disabled = !(total===100 && sum(types.map(t=>t.pct))===100);
}

function refreshWeighted(){
  const total = lifeFields.reduce((acc,k)=> acc + Number(life[k]||0) * Number(fixedWeights[k]||0), 0);
  weighted.textContent = total.toFixed(2);
}

function option10to100(){
  const f = document.createDocumentFragment();
  for(let i=10;i<=100;i+=10){
    const o = document.createElement('option');
    o.value=i; o.textContent=i;
    f.appendChild(o);
  }
  return f;
}

function refreshTypesUI(){
  typesGrid.innerHTML = "";
  types.forEach((t,idx)=>{
    const card = document.createElement('div'); card.className="type-card";

    const ico = document.createElement('div'); ico.className="type-ico";
    const img = document.createElement('img');
    const imgPath = getTypeImagePath(t.type);
    if(imgPath){
      img.src = imgPath;
      img.alt = t.type;
      img.onerror = ()=>{ ico.textContent = "üîπ"; img.remove(); };
      ico.appendChild(img);
    }else{
      ico.textContent = "üîπ";
    }

    const row = document.createElement('div'); row.className="type-row";

    const pctBox = document.createElement('div'); pctBox.style.display="flex"; pctBox.style.alignItems="center"; pctBox.style.gap="6px"; pctBox.style.minWidth="0";
    const pct = document.createElement('input'); pct.type="number"; pct.className="input"; pct.value=t.pct; pct.min=0; pct.max=100; pct.style.minWidth="0";
    pct.addEventListener('input', e=>{
      types[idx].pct = clamp(Number(e.target.value||0),0,100); save(LS.typeDedication, types); refreshTypeTotals();
    });
    const pctLbl = document.createElement('span'); pctLbl.textContent="%"; pctLbl.className="muted";
    pctBox.appendChild(pct); pctBox.appendChild(pctLbl);

    const pot = document.createElement('select'); pot.className="input"; pot.appendChild(option10to100()); pot.value=t.potencial; pot.style.minWidth="0";
    pot.addEventListener('change', e=>{ types[idx].potencial = Number(e.target.value); save(LS.typeDedication, types); });

    row.appendChild(pctBox); row.appendChild(pot);
    card.appendChild(ico); card.appendChild(row);
    typesGrid.appendChild(card);
  });
  refreshTypeTotals();
}

function refreshTypeTotals(){
  const total = sum(types.map(t=>t.pct));
  typeBar.style.width = Math.min(100,total) + "%";
  typeBadge.textContent = `Total ${total}%`;
  typeBadge.className = "badge " + (total===100 ? "ok":"warn");
  btnGerar.disabled = !(sum(Object.values(life))===100 && total===100);
}

// ---------- C√°lculo de Maestria (Sugest√£o 3: Sistema H√≠brido com B√¥nus) ----------
function calculateMasteryPoints(typeDedication, typePotential){
  const dias = Math.max(0, Number(trainer.anos||0)) * 365;
  const dedicacaoGeral = Number(trainer.dedicacaoGeral||0);
  const potencialGeral = Number(trainer.potencialGeral||0);
  const indicePonderado = lifeFields.reduce((acc,k)=> acc + Number(life[k]||0) * Number(fixedWeights[k]||0), 0);

  // Experi√™ncia_Base = (Dias √ó 5) √ó (Dedica√ß√£o_Geral/100) √ó (√çndice_Ponderado/100)
  // Cada dia vale 5 pontos base
  const experienciaBase = (dias * 5) * (dedicacaoGeral / 100) * (indicePonderado / 100);

  // Multiplicador_Tipo = (Dedica√ß√£o_Tipo/100) √ó (Potencial_Tipo/100)
  const multiplicadorTipo = (typeDedication / 100) * (typePotential / 100);

  // B√¥nus_Potencial = 1 + (Potencial_Geral - 50)/100
  const bonusPotencial = 1 + (potencialGeral - 50) / 100;

  // Pontos_Tipo = Experi√™ncia_Base √ó Multiplicador_Tipo √ó B√¥nus_Potencial
  const pontos = experienciaBase * multiplicadorTipo * bonusPotencial;

  return Math.round(pontos * 10) / 10; // Arredonda para 1 casa decimal
}

function getMasteryLevel(points){
  // Encontra o n√≠vel de maestria baseado nos pontos
  const sorted = [...masteries].sort((a,b) => b.value - a.value);
  for(const m of sorted){
    if(points >= m.value) return m.name;
  }
  return masteries[0].name; // "Sem Maestria"
}

function calculateAllMasteries(){
  return types.map(t => ({
    type: t.type,
    dedication: t.pct,
    potential: t.potencial,
    points: calculateMasteryPoints(t.pct, t.potencial),
    level: ''
  })).map(t => ({
    ...t,
    level: getMasteryLevel(t.points)
  }));
}

function showPrintView(){
  const totalLife = sum(Object.values(life));
  const totalTypes = sum(types.map(t=>t.pct));
  if(totalLife!==100 || totalTypes!==100){
    alert('Complete os dados: Dedica√ß√£o por aspecto de vida e Maestria por tipo devem somar 100% cada.');
    return;
  }

  // Calcula maestrias
  const results = calculateAllMasteries();

  // Atualiza data e √≠ndice
  document.getElementById('printDate').textContent = new Date().toLocaleString();
  const indice = lifeFields.reduce((acc,k)=>acc + Number(life[k]||0)*Number(fixedWeights[k]||0), 0).toFixed(2);
  document.getElementById('printIndice').textContent = indice;

  // Foto compacta
  const printPhoto = document.getElementById('printPhoto');
  if(photo){
    printPhoto.innerHTML = `<img src="${photo}" alt="Foto do treinador">`;
  }else{
    printPhoto.innerHTML = '<span style="color:#94a3b8;font-size:11px">Sem foto</span>';
  }

  // Perfil compacto - informa√ß√µes em linha
  const printProfileInfo = document.getElementById('printProfileInfo');
  printProfileInfo.innerHTML = `
    <div class="print-info-item">
      <span class="label">Nome</span>
      <span class="value">${trainer.nome || '-'}</span>
    </div>
    <div class="print-info-item">
      <span class="label">Anos</span>
      <span class="value">${trainer.anos || 0} (${Math.max(0, Number(trainer.anos||0))*365} dias)</span>
    </div>
    <div class="print-info-item">
      <span class="label">Dedica√ß√£o</span>
      <span class="value">${trainer.dedicacaoGeral || 0}%</span>
    </div>
    <div class="print-info-item">
      <span class="label">Potencial</span>
      <span class="value">${trainer.potencialGeral || 0}%</span>
    </div>
  `;

  // Maestrias por tipo - LAYOUT HORIZONTAL compacto (√≠cone + maestria + pontos)
  const printTypesGrid = document.getElementById('printTypesGrid');
  printTypesGrid.innerHTML = '';
  results.forEach(r => {
    const item = document.createElement('div');
    item.className = 'print-type-item';

    // Imagem do tipo
    const ico = document.createElement('div');
    ico.className = 'type-ico';
    const imgPath = getTypeImagePath(r.type);
    if(imgPath){
      const img = document.createElement('img');
      img.src = imgPath;
      img.alt = r.type;
      img.onerror = ()=>{ ico.textContent = 'üîπ'; img.remove(); };
      ico.appendChild(img);
    }else{
      ico.textContent = 'üîπ';
    }

    // Container de informa√ß√µes
    const typeInfo = document.createElement('div');
    typeInfo.className = 'type-info';

    // N√≠vel de maestria
    const typeLevel = document.createElement('div');
    typeLevel.className = 'type-level';
    typeLevel.textContent = r.level;

    // Pontos
    const typePoints = document.createElement('div');
    typePoints.className = 'type-points';
    typePoints.textContent = `${r.points} pts`;

    typeInfo.appendChild(typeLevel);
    typeInfo.appendChild(typePoints);

    // Monta item horizontalmente
    item.appendChild(ico);
    item.appendChild(typeInfo);
    printTypesGrid.appendChild(item);
  });

  // Alterna para modo de visualiza√ß√£o
  document.getElementById('editMode').classList.add('hidden');
  document.getElementById('viewMode').classList.add('active');
  window.scrollTo(0, 0);
}

function showEditView(){
  document.getElementById('viewMode').classList.remove('active');
  document.getElementById('editMode').classList.remove('hidden');
  window.scrollTo(0, 0);
}

async function downloadAsJPG(){
  // Oculta os bot√µes temporariamente
  const actions = document.querySelector('.print-actions');
  actions.style.display = 'none';

  try {
    // Captura o elemento de layout
    const element = document.querySelector('.print-layout');

    // Gera o canvas
    const canvas = await html2canvas(element, {
      scale: 2, // Qualidade 2x
      backgroundColor: '#f8fafc',
      logging: false,
      useCORS: true,
      allowTaint: true
    });

    // Converte para JPG
    const dataUrl = canvas.toDataURL('image/jpeg', 0.95);

    // Cria link de download
    const link = document.createElement('a');
    link.download = `techterra_maestria_${Date.now()}.jpg`;
    link.href = dataUrl;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  } catch(error) {
    console.error('Erro ao gerar imagem:', error);
    alert('Erro ao gerar imagem. Tente novamente.');
  } finally {
    // Restaura os bot√µes
    actions.style.display = 'flex';
  }
}

// Config modal (pesos fixos, s√≥ leitura)
function openConfig(){
  const tbM = document.querySelector('#tblMasteries tbody'); tbM.innerHTML="";
  masteries.forEach((m,i)=>{
    const tr = document.createElement('tr');
    const td1 = document.createElement('td');
    const inp1 = document.createElement('input');
    inp1.className="input"; inp1.value=m.name;
    inp1.addEventListener('input',e=>{ masteries[i].name=e.target.value; save(LS.masteryLevels, masteries); });
    td1.appendChild(inp1);
    const td2 = document.createElement('td');
    const inp2 = document.createElement('input');
    inp2.type="number"; inp2.className="input"; inp2.value=m.value;
    inp2.addEventListener('input',e=>{ masteries[i].value=Number(e.target.value||0); save(LS.masteryLevels, masteries); });
    td2.appendChild(inp2);
    tr.appendChild(td1); tr.appendChild(td2); tbM.appendChild(tr);
  });

  const tbP = document.querySelector('#tblPesos tbody'); tbP.innerHTML="";
  lifeFields.forEach(k=>{
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.textContent=k;
    const td2 = document.createElement('td'); td2.textContent = fixedWeights[k];
    tr.appendChild(td1); tr.appendChild(td2); tbP.appendChild(tr);
  });

  dlg.showModal();
}


// ---------- Liga√ß√µes de UI ----------
const dlg = document.getElementById('dlg');
btnConfig.addEventListener('click', openConfig);
dlg.addEventListener('close', ()=>{});

// Upload
imgInput.addEventListener('change', e=>{
  const f = e.target.files && e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    photo = reader.result;
    localStorage.setItem(LS.uploadedImage, photo);
    imgPreview.src = photo;
  };
  reader.readAsDataURL(f);
});

// Inputs simples
nome.addEventListener('input', e=>{ trainer.nome=e.target.value; save(LS.trainerPanel, trainer); });
anos.addEventListener('input', e=>{ trainer.anos=clamp(Number(e.target.value||0),0,999); save(LS.trainerPanel, trainer); refreshTrainerUI(); });
dedGeral.addEventListener('input', e=>{ trainer.dedicacaoGeral=clamp(Number(e.target.value||0),0,100); save(LS.trainerPanel, trainer); });
potGeral.addEventListener('input', e=>{ trainer.potencialGeral=clamp(Number(e.target.value||0),0,100); save(LS.trainerPanel, trainer); });

// Bot√£o calcular maestrias - alterna para modo de visualiza√ß√£o
btnGerar.addEventListener('click', showPrintView);

// Bot√µes do modo de visualiza√ß√£o
document.getElementById('btnBackEdit').addEventListener('click', showEditView);
document.getElementById('btnDownloadJPG').addEventListener('click', downloadAsJPG);

// Inicializa√ß√£o
refreshTrainerUI();
refreshLifeUI();
refreshTypesUI();

</script>
</body>
</html>
